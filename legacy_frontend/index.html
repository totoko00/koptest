<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Job Matching Demo</title>
<style>
.tab { display:none; }
.active { display:block; }
</style>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<button onclick="showTab('jobs')">求人データ</button>
<button onclick="showTab('seekers')">求職者データ</button>
<button onclick="showTab('match')">マッチング結果</button>

<div id="jobs" class="tab">
  <h3>求人データ入力</h3>
  <input type="file" id="jobsFile" accept=".txt,.csv,.xlsx,.xls"><br>
  <button onclick="processJobs()">整理</button>
  <span id="jobsStatus" style="display:none;">処理中...</span>
</div>

<div id="seekers" class="tab">
  <h3>求職者データ入力</h3>
  <input type="file" id="seekersFile" accept=".txt,.csv,.xlsx,.xls"><br>
  <button onclick="processSeekers()">整理</button>
  <span id="seekersStatus" style="display:none;">処理中...</span>
</div>

<div id="match" class="tab">
  <h3>マッチング</h3>
  <div>
    <h4>求人データ</h4>
    <input type="file" id="jobsFileMatch" accept=".txt,.csv,.xlsx,.xls"><br>
    <button onclick="processJobs('jobsFileMatch','jobsStatusMatch', false)">データ読込</button>
    <span id="jobsStatusMatch" style="display:none;">処理中...</span>
    <span id="jobsIndicator">データ無し</span>
  </div>
  <div>
    <h4>求職者データ</h4>
    <input type="file" id="seekersFileMatch" accept=".txt,.csv,.xlsx,.xls"><br>
    <button onclick="processSeekers('seekersFileMatch','seekersStatusMatch', false)">データ読込</button>
    <span id="seekersStatusMatch" style="display:none;">処理中...</span>
    <span id="seekersIndicator">データ無し</span>
  </div>
  <button onclick="runMatch()">マッチ実行</button>
  <span id="matchStatus" style="display:none;">処理中...</span>
  <pre id="matchText"></pre>
</div>

<script>
let jobsCsv = "";
let seekersCsv = "";

function showTab(id) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function downloadCsv(csvText, filename) {
  const blob = new Blob([csvText], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

async function readUpload(input) {
  const file = input.files[0];
  if (!file) {
    alert('ファイルを選択してください');
    return null;
  }
  const ext = file.name.split('.').pop().toLowerCase();
  if (ext === 'txt' || ext === 'csv') {
    return await file.text();
  } else if (ext === 'xlsx' || ext === 'xls') {
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, {type: 'array'});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    return XLSX.utils.sheet_to_csv(sheet);
  } else {
    alert('対応していないファイル形式です');
    return null;
  }
}

function updateIndicators() {
  const jobsInd = document.getElementById('jobsIndicator');
  if (jobsInd) jobsInd.textContent = jobsCsv ? 'データ有り' : 'データ無し';
  const seekersInd = document.getElementById('seekersIndicator');
  if (seekersInd) seekersInd.textContent = seekersCsv ? 'データ有り' : 'データ無し';
}

async function processJobs(inputId='jobsFile', statusId='jobsStatus', download=true) {
  const text = await readUpload(document.getElementById(inputId));
  if (!text) return;
  const jobsStatus = document.getElementById(statusId);
  jobsStatus.style.display = 'inline';
  const res = await fetch('/process_jobs', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({text})
  });
  const data = await res.json();
  jobsStatus.style.display = 'none';
  jobsCsv = data.csv;
  if (download) {
    downloadCsv(jobsCsv, 'jobs.csv');
  }
  updateIndicators();
}

async function processSeekers(inputId='seekersFile', statusId='seekersStatus', download=true) {
  const text = await readUpload(document.getElementById(inputId));
  if (!text) return;
  const seekersStatus = document.getElementById(statusId);
  seekersStatus.style.display = 'inline';
  const res = await fetch('/process_seekers', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({text})
  });
  const data = await res.json();
  seekersStatus.style.display = 'none';
  seekersCsv = data.csv;
  if (download) {
    downloadCsv(seekersCsv, 'seekers.csv');
  }
  updateIndicators();
}

async function runMatch() {
  const matchStatus = document.getElementById('matchStatus');
  matchStatus.style.display = 'inline';
  const res = await fetch('/match', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({jobs_csv: jobsCsv, seekers_csv: seekersCsv})
  });
  const data = await res.json();
  matchStatus.style.display = 'none';
  document.getElementById('matchText').textContent = data.csv;
  downloadCsv(data.csv, 'match.csv');
}

showTab('jobs');
updateIndicators();
</script>
</body>
</html>
